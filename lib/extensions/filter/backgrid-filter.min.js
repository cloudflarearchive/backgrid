/*
  backgrid-filter
  http://github.com/wyuenho/backgrid

  Copyright (c) 2013 Jimmy Yuen Ho Wong and contributors
  Licensed under the MIT @license.
*/
(function(e,t,i,l,n){"use strict";var s=l.Extension.ServerSideFilter=i.View.extend({tagName:"form",className:"backgrid-filter form-search",template:t.template('<div class="input-prepend input-append"><span class="add-on"><i class="icon-search"></i></span><input type="text" <% if (placeholder) { %> placeholder="<%- placeholder %>" <% } %> name="<%- name %>" <% if (value) { %> value="<%- value %>" <% } %> /><span class="add-on"><a class="close" href="#">&times;</a></span></div>'),events:{"click .close":"clear",submit:"filter"},name:"q",placeholder:null,value:null,initialize:function(e){i.View.prototype.initialize.apply(this,arguments),this.name=e.name||this.name,this.placeholder=e.placeholder||this.placeholder,this.value=e.value||this.value},filter:function(t){t.preventDefault();var i=e(t.target).find(":text"),l={};l[i.attr("name")]=i.val(),this.collection.fetch({data:l})},clear:function(e){e.preventDefault(),this.$el.find(":text").val(null),this.collection.fetch()},render:function(){return this.$el.empty().append(this.template({name:this.name,placeholder:this.placeholder,value:this.value})),this.delegateEvents(),this}});l.Extension.ClientSideFilter=s.extend({events:{"click .close":function(e){e.preventDefault(),this.clear.apply(this,arguments)},"change :text":"filter","keyup :text":"filter",submit:function(e){e.preventDefault(),this.filter.apply(this,arguments)}},ref:"id",fields:null,wait:150,initialize:function(e){s.prototype.initialize.apply(this,arguments),this.fields=e.fields||this.fields,this.ref=e.ref||this.ref,this.wait=e.wait||this.wait,this._debounceMethods(["filter","clear"]);var t=this.collection.fullCollection||this.collection;this.resetIndex(t),this.listenTo(t,"reset",this.resetIndex),this.listenTo(t,"remove",this.removeFromIndex),this.listenTo(t,"change",this.updateIndex)},_debounceMethods:function(e){t.isString(e)&&(e=[e]),this.undelegateEvents();for(var i=0,l=e.length;l>i;i++){var n=e[i],s=this[n];this[n]=t.debounce(s,this.wait)}this.delegateEvents()},resetIndex:function(e,i){if(i=t.extend({reindex:!0},i||{}),i.reindex){var l=this,s=this.index=n(function(){t.each(l.fields,function(e,t){this.field(t,e),this.ref(l.ref)},this)}),a=s.documentStore;e.each(function(e){var t=e.toJSON();t[this.ref]&&a.has(t[this.ref])?s.update(t):s.add(t)},this),this.shadowCollection=e.clone()}},removeFromIndex:function(e){var t=this.index,i=e.toJSON();i[this.ref]&&t.documentStore.has(i[this.ref])&&t.remove(i)},updateIndex:function(e){this.index.update(e.toJSON())},filter:function(){for(var e=this.index.search(this.$el.find(":text").val()),t=[],i=0;e.length>i;i++){var l=e[i];t.push(this.shadowCollection.get(l.ref))}var n=this.collection.fullCollection||this.collection;n.reset(t,{reindex:!1})},clear:function(){this.$el.find(":text").val(null);var e=this.collection.fullCollection||this.collection;e.reset(this.shadowCollection.models,{reindex:!1})}})})(jQuery,_,Backbone,Backgrid,lunr);